version: '3.9'

x-deploy-defaults: &deploy_defaults
  restart_policy:
    condition: on-failure
    delay: 5s
    max_attempts: 3
    window: 30s
  update_config:
    parallelism: 1
    order: start-first
  rollback_config:
    parallelism: 1
    order: stop-first

services:
  postgres:
    image: postgres:16-alpine
    entrypoint:
      - /usr/local/bin/pgbackrest-entrypoint.sh
    command:
      [
        "postgres",
        "-c",
        "max_connections=${POSTGRES_MAX_CONNECTIONS:-200}",
        "-c",
        "archive_mode=on",
        "-c",
        "archive_timeout=60",
        "-c",
        "archive_command=pgbackrest --stanza=${PGBACKREST_STANZA:-my-ads} --repo1-cipher-type=aes-256-cbc --repo1-cipher-pass=Ghader archive-push %p"
      ]
    environment:
      POSTGRES_DB: ${POSTGRES_DB}
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:?POSTGRES_PASSWORD not set}
      PGPORT: ${POSTGRES_INTERNAL_PORT}
      PGBACKREST_STANZA: ${PGBACKREST_STANZA:-my-ads}
      PGBACKREST_PG1_PATH: /var/lib/postgresql/data
      PGBACKREST_PG1_PORT: ${POSTGRES_INTERNAL_PORT}
      PGBACKREST_PG1_SOCKET_PATH: /var/run/postgresql
      PGBACKREST_PG1_USER: ${POSTGRES_USER}
      PGBACKREST_REPO1_TYPE: s3
      PGBACKREST_REPO1_PATH: /pgbackrest
      PGBACKREST_REPO1_S3_BUCKET: db-backup
      PGBACKREST_REPO1_S3_ENDPOINT: ${MINIO_ENDPOINT}:${MINIO_PORT}
      PGBACKREST_REPO1_S3_REGION: ${MINIO_REGION}
      PGBACKREST_REPO1_S3_KEY: ${MINIO_ACCESS_KEY:?MINIO_ACCESS_KEY not set}
      PGBACKREST_REPO1_S3_KEY_SECRET: ${MINIO_SECRET_KEY:?MINIO_SECRET_KEY not set}
      PGBACKREST_REPO1_S3_URI_STYLE: path
      PGBACKREST_REPO1_S3_VERIFY_TLS: ${PGBACKREST_REPO1_S3_VERIFY_TLS:-n}
      PGBACKREST_REPO1_BUNDLE: y
      PGBACKREST_REPO1_BUNDLE_SIZE: 1GiB
      PGBACKREST_REPO1_COMPRESS_TYPE: zst
      PGBACKREST_REPO1_COMPRESS_LEVEL: 9
      PGBACKREST_REPO1_RETENTION_FULL_TYPE: time
      PGBACKREST_REPO1_RETENTION_FULL: 30
      PGBACKREST_REPO1_RETENTION_ARCHIVE_TYPE: time
      PGBACKREST_REPO1_RETENTION_ARCHIVE: 30
    ports:
      - target: ${POSTGRES_INTERNAL_PORT}
        published: ${POSTGRES_PUBLISHED_PORT}
        protocol: tcp
        mode: host
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - postgres_socket:/var/run/postgresql
      - ./scripts/pgbackrest/postgres-entrypoint.sh:/usr/local/bin/pgbackrest-entrypoint.sh:ro
    networks:
      - app_net
    deploy:
      <<: *deploy_defaults
      update_config:
        parallelism: 1
        order: stop-first
      replicas: 1
      placement:
        constraints:
          - node.role == manager

  pgbackrest-backup:
    image: ghcr.io/radiophp/my-ads-backup:latest
    environment:
      TZ: ${BACKUP_TZ:-Asia/Tehran}
      BACKUP_CRON: ${BACKUP_CRON:-0 2 * * *}
      BACKUP_TELEGRAM_PHONES: ${BACKUP_TELEGRAM_PHONES:-+989038923989,+989195043739}
      TELEGRAM_BOT_TOKEN: ${TELEGRAM_BOT_TOKEN:?TELEGRAM_BOT_TOKEN not set}
      POSTGRES_HOST: postgres
      POSTGRES_PORT: ${POSTGRES_INTERNAL_PORT}
      POSTGRES_DB: ${POSTGRES_DB}
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:?POSTGRES_PASSWORD not set}
      MINIO_ENDPOINT: ${MINIO_ENDPOINT}
      MINIO_PORT: ${MINIO_PORT}
      MINIO_USE_SSL: ${MINIO_USE_SSL}
      MINIO_ACCESS_KEY: ${MINIO_ACCESS_KEY:?MINIO_ACCESS_KEY not set}
      MINIO_SECRET_KEY: ${MINIO_SECRET_KEY:?MINIO_SECRET_KEY not set}
      MINIO_REGION: ${MINIO_REGION}
      PGBACKREST_STANZA: ${PGBACKREST_STANZA:-my-ads}
      PGBACKREST_PG1_PATH: /var/lib/postgresql/data
      PGBACKREST_PG1_PORT: ${POSTGRES_INTERNAL_PORT}
      PGBACKREST_PG1_SOCKET_PATH: /var/run/postgresql
      PGBACKREST_PG1_USER: ${POSTGRES_USER}
      PGBACKREST_REPO1_TYPE: s3
      PGBACKREST_REPO1_PATH: /pgbackrest
      PGBACKREST_REPO1_S3_BUCKET: db-backup
      PGBACKREST_REPO1_S3_ENDPOINT: ${MINIO_ENDPOINT}:${MINIO_PORT}
      PGBACKREST_REPO1_S3_REGION: ${MINIO_REGION}
      PGBACKREST_REPO1_S3_KEY: ${MINIO_ACCESS_KEY:?MINIO_ACCESS_KEY not set}
      PGBACKREST_REPO1_S3_KEY_SECRET: ${MINIO_SECRET_KEY:?MINIO_SECRET_KEY not set}
      PGBACKREST_REPO1_S3_URI_STYLE: path
      PGBACKREST_REPO1_S3_VERIFY_TLS: ${PGBACKREST_REPO1_S3_VERIFY_TLS:-n}
      PGBACKREST_REPO1_BUNDLE: y
      PGBACKREST_REPO1_BUNDLE_SIZE: 1GiB
      PGBACKREST_REPO1_COMPRESS_TYPE: zst
      PGBACKREST_REPO1_COMPRESS_LEVEL: 9
      PGBACKREST_REPO1_RETENTION_FULL_TYPE: time
      PGBACKREST_REPO1_RETENTION_FULL: 30
      PGBACKREST_REPO1_RETENTION_ARCHIVE_TYPE: time
      PGBACKREST_REPO1_RETENTION_ARCHIVE: 30
    volumes:
      - postgres_data:/var/lib/postgresql/data:ro
      - postgres_socket:/var/run/postgresql
    depends_on:
      - postgres
      - minio
    networks:
      - app_net
    deploy:
      <<: *deploy_defaults
      replicas: 1
      placement:
        constraints:
          - node.role == manager

  redis:
    image: redis:7-alpine
    command:
      [
        "redis-server",
        "--port",
        "${REDIS_PORT}"
      ]
    ports:
      - target: ${REDIS_PORT}
        published: ${REDIS_PORT}
        protocol: tcp
        mode: ingress
    networks:
      - app_net
    deploy:
      <<: *deploy_defaults
      replicas: 1

  rabbitmq:
    image: rabbitmq:3.13-management
    environment:
      RABBITMQ_DEFAULT_USER: ${RABBITMQ_USERNAME}
      RABBITMQ_DEFAULT_PASS: ${RABBITMQ_PASSWORD}
    volumes:
      - rabbitmq_data:/var/lib/rabbitmq
    networks:
      - app_net
    deploy:
      <<: *deploy_defaults
      replicas: 1

  minio:
    image: minio/minio:RELEASE.2025-02-28T09-55-16Z
    command:
      [
        "server",
        "/data",
        "--console-address",
        ":${MINIO_CONSOLE_PORT}",
        "--address",
        ":${MINIO_PORT}"
      ]
    environment:
      MINIO_ROOT_USER: ${MINIO_ACCESS_KEY:?MINIO_ACCESS_KEY not set}
      MINIO_ROOT_PASSWORD: ${MINIO_SECRET_KEY:?MINIO_SECRET_KEY not set}
    volumes:
      - minio_data:/data
    ports:
      - target: ${MINIO_PORT}
        published: ${MINIO_PORT}
        protocol: tcp
        mode: ingress
      - target: ${MINIO_CONSOLE_PORT}
        published: ${MINIO_CONSOLE_PORT}
        protocol: tcp
        mode: ingress
    networks:
      - app_net
    deploy:
      <<: *deploy_defaults
      replicas: 1

  api:
    image: ghcr.io/radiophp/my-ads-api:latest
    environment:
      NODE_ENV: production
      ENABLE_CRON_JOBS: 'false'
      APP_HOST: 0.0.0.0
      APP_PORT: ${APP_PORT}
      APP_GLOBAL_PREFIX: ${APP_GLOBAL_PREFIX}
      DATABASE_URL: ${DATABASE_URL}
      DATABASE_DIRECT_URL: ${DATABASE_DIRECT_URL}
      REDIS_HOST: ${REDIS_HOST}
      REDIS_PORT: ${REDIS_PORT}
      REDIS_DB: ${REDIS_DB}
      REDIS_TLS: ${REDIS_TLS}
      REDIS_KEY_PREFIX: ${REDIS_KEY_PREFIX}
      JWT_ACCESS_TOKEN_SECRET: ${JWT_ACCESS_TOKEN_SECRET:?JWT_ACCESS_TOKEN_SECRET not set}
      JWT_REFRESH_TOKEN_SECRET: ${JWT_REFRESH_TOKEN_SECRET:?JWT_REFRESH_TOKEN_SECRET not set}
      JWT_ACCESS_TOKEN_TTL: ${JWT_ACCESS_TOKEN_TTL}
      JWT_REFRESH_TOKEN_TTL: ${JWT_REFRESH_TOKEN_TTL}
      CORS_ORIGIN: ${CORS_ORIGIN}
      RATE_LIMIT_TTL: ${RATE_LIMIT_TTL}
      RATE_LIMIT_MAX: ${RATE_LIMIT_MAX}
      OTP_TTL_SECONDS: ${OTP_TTL_SECONDS}
      OTP_DIGITS: ${OTP_DIGITS}
      RABBITMQ_URL: ${RABBITMQ_URL}
      RABBITMQ_QUEUE_PREFIX: ${RABBITMQ_QUEUE_PREFIX}
      RABBITMQ_PREFETCH: ${RABBITMQ_PREFETCH}
      RABBITMQ_HEARTBEAT: ${RABBITMQ_HEARTBEAT}
      RABBITMQ_RECONNECT_SECONDS: ${RABBITMQ_RECONNECT_SECONDS}
      VAPID_PUBLIC_KEY: ${VAPID_PUBLIC_KEY}
      VAPID_PRIVATE_KEY: ${VAPID_PRIVATE_KEY}
      VAPID_SUBJECT: ${VAPID_SUBJECT}
      PUSH_NOTIFICATION_TIMEOUT_MS: ${PUSH_NOTIFICATION_TIMEOUT_MS}
      MINIO_ENDPOINT: ${MINIO_ENDPOINT}
      MINIO_PORT: ${MINIO_PORT}
      MINIO_CONSOLE_PORT: ${MINIO_CONSOLE_PORT}
      MINIO_USE_SSL: ${MINIO_USE_SSL}
      MINIO_ACCESS_KEY: ${MINIO_ACCESS_KEY:?MINIO_ACCESS_KEY not set}
      MINIO_SECRET_KEY: ${MINIO_SECRET_KEY:?MINIO_SECRET_KEY not set}
      MINIO_BUCKET: ${MINIO_BUCKET}
      MINIO_REGION: ${MINIO_REGION}
      MINIO_PUBLIC_ENDPOINT: ${MINIO_PUBLIC_ENDPOINT}
      MINIO_PUBLIC_PORT: ${MINIO_PUBLIC_PORT}
      MINIO_PUBLIC_USE_SSL: ${MINIO_PUBLIC_USE_SSL}
      MINIO_PUBLIC_PATH: ${MINIO_PUBLIC_PATH}
      NEXT_PUBLIC_APP_URL: ${NEXT_PUBLIC_APP_URL}
      NEXT_PUBLIC_API_BASE_URL: ${NEXT_PUBLIC_API_BASE_URL}
      OTEL_ENABLED: ${OTEL_ENABLED}
      OTEL_SERVICE_NAME: ${OTEL_SERVICE_NAME}
      OTEL_EXPORTER_OTLP_ENDPOINT: ${OTEL_EXPORTER_OTLP_ENDPOINT}
      OTEL_EXPORTER_OTLP_HEADERS: ${OTEL_EXPORTER_OTLP_HEADERS}
      OTEL_LOG_LEVEL: ${OTEL_LOG_LEVEL}
      LOG_LEVEL: ${LOG_LEVEL}
      LOG_PRETTY: ${LOG_PRETTY}
      PRISMA_LOG_QUERIES: ${PRISMA_LOG_QUERIES}
      NEXT_UI_PORT: ${NEXT_UI_PORT}
    ports:
      - target: ${APP_PORT}
        published: ${APP_PORT}
        protocol: tcp
        mode: ingress
    networks:
      - app_net
    depends_on:
      - postgres
      - redis
      - rabbitmq
      - minio
    deploy:
      <<: *deploy_defaults
      replicas: ${API_REPLICAS}
      placement:
        constraints:
          - node.role == manager

  api-cron:
    image: ghcr.io/radiophp/my-ads-api:latest
    command:
      [
        "node",
        "dist/scripts/run-cron-scheduler.js"
      ]
    environment:
      NODE_ENV: production
      ENABLE_CRON_JOBS: 'true'
      APP_HOST: 0.0.0.0
      APP_PORT: ${APP_PORT}
      APP_GLOBAL_PREFIX: ${APP_GLOBAL_PREFIX}
      DATABASE_URL: ${DATABASE_URL}
      DATABASE_DIRECT_URL: ${DATABASE_DIRECT_URL}
      REDIS_HOST: ${REDIS_HOST}
      REDIS_PORT: ${REDIS_PORT}
      REDIS_DB: ${REDIS_DB}
      REDIS_TLS: ${REDIS_TLS}
      REDIS_KEY_PREFIX: ${REDIS_KEY_PREFIX}
      JWT_ACCESS_TOKEN_SECRET: ${JWT_ACCESS_TOKEN_SECRET:?JWT_ACCESS_TOKEN_SECRET not set}
      JWT_REFRESH_TOKEN_SECRET: ${JWT_REFRESH_TOKEN_SECRET:?JWT_REFRESH_TOKEN_SECRET not set}
      JWT_ACCESS_TOKEN_TTL: ${JWT_ACCESS_TOKEN_TTL}
      JWT_REFRESH_TOKEN_TTL: ${JWT_REFRESH_TOKEN_TTL}
      CORS_ORIGIN: ${CORS_ORIGIN}
      RATE_LIMIT_TTL: ${RATE_LIMIT_TTL}
      RATE_LIMIT_MAX: ${RATE_LIMIT_MAX}
      OTP_TTL_SECONDS: ${OTP_TTL_SECONDS}
      OTP_DIGITS: ${OTP_DIGITS}
      RABBITMQ_URL: ${RABBITMQ_URL}
      RABBITMQ_QUEUE_PREFIX: ${RABBITMQ_QUEUE_PREFIX}
      RABBITMQ_PREFETCH: ${RABBITMQ_PREFETCH}
      RABBITMQ_HEARTBEAT: ${RABBITMQ_HEARTBEAT}
      RABBITMQ_RECONNECT_SECONDS: ${RABBITMQ_RECONNECT_SECONDS}
      VAPID_PUBLIC_KEY: ${VAPID_PUBLIC_KEY}
      VAPID_PRIVATE_KEY: ${VAPID_PRIVATE_KEY}
      VAPID_SUBJECT: ${VAPID_SUBJECT}
      PUSH_NOTIFICATION_TIMEOUT_MS: ${PUSH_NOTIFICATION_TIMEOUT_MS}
      MINIO_ENDPOINT: ${MINIO_ENDPOINT}
      MINIO_PORT: ${MINIO_PORT}
      MINIO_CONSOLE_PORT: ${MINIO_CONSOLE_PORT}
      MINIO_USE_SSL: ${MINIO_USE_SSL}
      MINIO_ACCESS_KEY: ${MINIO_ACCESS_KEY:?MINIO_ACCESS_KEY not set}
      MINIO_SECRET_KEY: ${MINIO_SECRET_KEY:?MINIO_SECRET_KEY not set}
      MINIO_BUCKET: ${MINIO_BUCKET}
      MINIO_REGION: ${MINIO_REGION}
      MINIO_PUBLIC_ENDPOINT: ${MINIO_PUBLIC_ENDPOINT}
      MINIO_PUBLIC_PORT: ${MINIO_PUBLIC_PORT}
      MINIO_PUBLIC_USE_SSL: ${MINIO_PUBLIC_USE_SSL}
      MINIO_PUBLIC_PATH: ${MINIO_PUBLIC_PATH}
      OTEL_ENABLED: ${OTEL_ENABLED}
      OTEL_SERVICE_NAME: ${OTEL_SERVICE_NAME}
      OTEL_EXPORTER_OTLP_ENDPOINT: ${OTEL_EXPORTER_OTLP_ENDPOINT}
      OTEL_EXPORTER_OTLP_HEADERS: ${OTEL_EXPORTER_OTLP_HEADERS}
      OTEL_LOG_LEVEL: ${OTEL_LOG_LEVEL}
      LOG_LEVEL: ${LOG_LEVEL}
      LOG_PRETTY: ${LOG_PRETTY}
      PRISMA_LOG_QUERIES: ${PRISMA_LOG_QUERIES}
      NEXT_UI_PORT: ${NEXT_UI_PORT}
      NEXT_PUBLIC_APP_URL: ${NEXT_PUBLIC_APP_URL}
      NEXT_PUBLIC_API_BASE_URL: ${NEXT_PUBLIC_API_BASE_URL}
    depends_on:
      - postgres
      - redis
      - rabbitmq
      - minio
    networks:
      - app_net
    deploy:
      <<: *deploy_defaults
      update_config:
        parallelism: 1
        order: stop-first
      replicas: ${API_CRON_REPLICAS}

  tileserver:
    image: maptiler/tileserver-gl:v4.8.0
    command: ["--mbtiles", "/data/iran.mbtiles", "--port", "8080"]
    ports:
      - target: 8080
        published: ${MAP_TILES_PORT}
        protocol: tcp
        mode: ingress
    volumes:
      - type: bind
        source: ${MAP_TILES_PATH}
        target: /data
        read_only: true
    networks:
      - app_net
    deploy:
      <<: *deploy_defaults
      replicas: 1
      placement:
        constraints:
          - node.role == manager

  otel-collector:
    image: otel/opentelemetry-collector-contrib:0.99.0
    command: ["--config=/etc/otel-collector.yaml"]
    volumes:
      - ./observability/otel-collector-config.yaml:/etc/otel-collector.yaml:ro
    ports:
      - target: ${OTEL_COLLECTOR_HTTP_PORT}
        published: ${OTEL_COLLECTOR_HTTP_PORT}
        protocol: tcp
        mode: ingress
    environment:
      OTEL_COLLECTOR_HTTP_PORT: ${OTEL_COLLECTOR_HTTP_PORT}
      OTEL_COLLECTOR_GRPC_PORT: ${OTEL_COLLECTOR_GRPC_PORT}
      TEMPO_GRPC_PORT: ${TEMPO_GRPC_PORT}
    networks:
      - app_net
    deploy:
      <<: *deploy_defaults
      replicas: 1

  loki:
    image: grafana/loki:2.9.3
    command:
      - "-config.file=/etc/loki/local-config.yaml"
      - "-frontend.instance-addr=127.0.0.1"
      - "-frontend.instance-port=9096"
      - "-frontend.scheduler-address=127.0.0.1:9096"
      - "-querier.scheduler-address=127.0.0.1:9096"
    volumes:
      - ./observability/loki-config.yaml:/etc/loki/local-config.yaml:ro
      - loki_data:/var/loki
    ports:
      - target: ${LOKI_PORT}
        published: ${LOKI_PORT}
        protocol: tcp
        mode: ingress
    environment:
      LOKI_PORT: ${LOKI_PORT}
    networks:
      - app_net
    deploy:
      <<: *deploy_defaults
      replicas: 1

  promtail:
    image: grafana/promtail:2.9.3
    command: ["--config.file=/etc/promtail/config.yaml"]
    volumes:
      - ./observability/promtail-config.yaml:/etc/promtail/config.yaml:ro
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - promtail_positions:/var/lib/promtail
    depends_on:
      - loki
    networks:
      - app_net
    deploy:
      <<: *deploy_defaults
      replicas: 1

  tempo:
    image: grafana/tempo:2.4.1
    command: ["-config.file=/etc/tempo.yaml"]
    volumes:
      - ./observability/tempo.yaml:/etc/tempo.yaml:ro
      - tempo_data:/var/tempo
    ports:
      - target: ${TEMPO_PORT}
        published: ${TEMPO_PORT}
        protocol: tcp
        mode: ingress
    environment:
      TEMPO_PORT: ${TEMPO_PORT}
      TEMPO_GRPC_PORT: ${TEMPO_GRPC_PORT}
    networks:
      - app_net
    deploy:
      <<: *deploy_defaults
      replicas: 1

  prometheus:
    image: prom/prometheus:v2.49.1
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--web.console.libraries=/usr/share/prometheus/console_libraries'
      - '--web.console.templates=/usr/share/prometheus/consoles'
      - '--web.listen-address=:${PROMETHEUS_PORT}'
    volumes:
      - ./observability/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - ./observability/prometheus-alerts.yml:/etc/prometheus/alerts/health-alerts.yml:ro
      - prometheus_data:/prometheus
    ports:
      - target: ${PROMETHEUS_PORT}
        published: ${PROMETHEUS_PORT}
        protocol: tcp
        mode: ingress
    environment:
      PROMETHEUS_PORT: ${PROMETHEUS_PORT}
    networks:
      - app_net
    deploy:
      <<: *deploy_defaults
      replicas: 1

  grafana:
    image: grafana/grafana:10.4.1
    environment:
      GF_SECURITY_ADMIN_USER: ${GRAFANA_ADMIN_USER}
      GF_SECURITY_ADMIN_EMAIL: ${GRAFANA_ADMIN_EMAIL}
      GF_SECURITY_ADMIN_PASSWORD: ${GRAFANA_ADMIN_PASSWORD}
      GF_FEATURE_TOGGLES_ENABLE: traceqlEditor
      GF_SERVER_HTTP_PORT: ${GRAFANA_PORT}
      GF_PATHS_PROVISIONING: /etc/grafana/provisioning
      PROMETHEUS_PORT: ${PROMETHEUS_PORT}
      LOKI_PORT: ${LOKI_PORT}
      TEMPO_PORT: ${TEMPO_PORT}
    volumes:
      - grafana_data:/var/lib/grafana
      - ./observability/grafana/provisioning/datasources:/etc/grafana/provisioning/datasources
      - ./observability/grafana/provisioning/dashboard-providers.yml:/etc/grafana/provisioning/dashboards/dashboard-providers.yml:ro
      - ./observability/grafana/provisioning/dashboards:/var/lib/grafana/dashboards
    depends_on:
      - loki
      - prometheus
      - tempo
    ports:
      - target: ${GRAFANA_PORT}
        published: ${GRAFANA_PORT}
        protocol: tcp
        mode: ingress
    networks:
      - app_net
    deploy:
      <<: *deploy_defaults
      replicas: 1

  telegram-bot:
    image: ghcr.io/radiophp/my-ads-api:latest
    command:
      [
        "node",
        "dist/scripts/run-telegram-bot.js"
      ]
    environment:
      NODE_ENV: production
      ENABLE_CRON_JOBS: 'false'
      APP_HOST: 0.0.0.0
      APP_PORT: ${APP_PORT}
      APP_GLOBAL_PREFIX: ${APP_GLOBAL_PREFIX}
      DATABASE_URL: ${DATABASE_URL}
      DATABASE_DIRECT_URL: ${DATABASE_DIRECT_URL}
      REDIS_HOST: ${REDIS_HOST}
      REDIS_PORT: ${REDIS_PORT}
      REDIS_DB: ${REDIS_DB}
      REDIS_TLS: ${REDIS_TLS}
      REDIS_KEY_PREFIX: ${REDIS_KEY_PREFIX}
      RABBITMQ_URL: ${RABBITMQ_URL}
      RABBITMQ_QUEUE_PREFIX: ${RABBITMQ_QUEUE_PREFIX}
      RABBITMQ_PREFETCH: ${RABBITMQ_PREFETCH}
      RABBITMQ_HEARTBEAT: ${RABBITMQ_HEARTBEAT}
      RABBITMQ_RECONNECT_SECONDS: ${RABBITMQ_RECONNECT_SECONDS}
      VAPID_PUBLIC_KEY: ${VAPID_PUBLIC_KEY}
      VAPID_PRIVATE_KEY: ${VAPID_PRIVATE_KEY}
      VAPID_SUBJECT: ${VAPID_SUBJECT}
      PUSH_NOTIFICATION_TIMEOUT_MS: ${PUSH_NOTIFICATION_TIMEOUT_MS}
      JWT_ACCESS_TOKEN_SECRET: ${JWT_ACCESS_TOKEN_SECRET:?JWT_ACCESS_TOKEN_SECRET not set}
      JWT_REFRESH_TOKEN_SECRET: ${JWT_REFRESH_TOKEN_SECRET:?JWT_REFRESH_TOKEN_SECRET not set}
      JWT_ACCESS_TOKEN_TTL: ${JWT_ACCESS_TOKEN_TTL}
      JWT_REFRESH_TOKEN_TTL: ${JWT_REFRESH_TOKEN_TTL}
      CORS_ORIGIN: ${CORS_ORIGIN}
      RATE_LIMIT_TTL: ${RATE_LIMIT_TTL}
      RATE_LIMIT_MAX: ${RATE_LIMIT_MAX}
      OTP_TTL_SECONDS: ${OTP_TTL_SECONDS}
      OTP_DIGITS: ${OTP_DIGITS}
      MINIO_ENDPOINT: ${MINIO_ENDPOINT}
      MINIO_PORT: ${MINIO_PORT}
      MINIO_CONSOLE_PORT: ${MINIO_CONSOLE_PORT}
      MINIO_USE_SSL: ${MINIO_USE_SSL}
      MINIO_ACCESS_KEY: ${MINIO_ACCESS_KEY:?MINIO_ACCESS_KEY not set}
      MINIO_SECRET_KEY: ${MINIO_SECRET_KEY:?MINIO_SECRET_KEY not set}
      MINIO_BUCKET: ${MINIO_BUCKET}
      MINIO_REGION: ${MINIO_REGION}
      MINIO_PUBLIC_ENDPOINT: ${MINIO_PUBLIC_ENDPOINT}
      MINIO_PUBLIC_PORT: ${MINIO_PUBLIC_PORT}
      MINIO_PUBLIC_USE_SSL: ${MINIO_PUBLIC_USE_SSL}
      MINIO_PUBLIC_PATH: ${MINIO_PUBLIC_PATH}
      OTEL_ENABLED: ${OTEL_ENABLED}
      OTEL_SERVICE_NAME: ${OTEL_SERVICE_NAME}
      OTEL_EXPORTER_OTLP_ENDPOINT: ${OTEL_EXPORTER_OTLP_ENDPOINT}
      OTEL_EXPORTER_OTLP_HEADERS: ${OTEL_EXPORTER_OTLP_HEADERS}
      OTEL_LOG_LEVEL: ${OTEL_LOG_LEVEL}
      LOG_LEVEL: ${LOG_LEVEL}
      LOG_PRETTY: ${LOG_PRETTY}
      PRISMA_LOG_QUERIES: ${PRISMA_LOG_QUERIES}
      TELEGRAM_BOT_TOKEN: ${TELEGRAM_BOT_TOKEN:?TELEGRAM_BOT_TOKEN not set}
      TELEGRAM_BOT_AUTOSTART: ${TELEGRAM_BOT_AUTOSTART:-true}
    depends_on:
      - postgres
      - redis
      - rabbitmq
    networks:
      - app_net
    deploy:
      <<: *deploy_defaults
      update_config:
        parallelism: 1
        order: stop-first
      replicas: ${TELEGRAM_BOT_REPLICAS}
      placement:
        constraints:
          - node.role == manager

  ui:
    image: ghcr.io/radiophp/my-ads-ui:latest
    environment:
      NODE_ENV: production
      NEXT_UI_PORT: ${NEXT_UI_PORT}
      PORT: ${NEXT_UI_PORT}
      NEXT_PUBLIC_APP_URL: ${NEXT_PUBLIC_APP_URL}
      NEXT_PUBLIC_API_BASE_URL: ${NEXT_PUBLIC_API_BASE_URL}
      NEXT_PUBLIC_VAPID_PUBLIC_KEY: ${NEXT_PUBLIC_VAPID_PUBLIC_KEY}
      NEXT_PUBLIC_ANALYTICS_WRITE_KEY: ${NEXT_PUBLIC_ANALYTICS_WRITE_KEY}
    depends_on:
      - api
    ports:
      - target: ${NEXT_UI_PORT}
        published: ${NEXT_UI_PORT}
        protocol: tcp
        mode: ingress
    networks:
      - app_net
    deploy:
      <<: *deploy_defaults
      replicas: ${UI_REPLICAS}
      placement:
        constraints:
          - node.role == manager

networks:
  app_net:
    driver: overlay
    attachable: true

volumes:
  postgres_data:
  postgres_socket:
  minio_data:
  loki_data:
  tempo_data:
  prometheus_data:
  grafana_data:
  promtail_positions:
  rabbitmq_data:
