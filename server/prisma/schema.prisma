generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider          = "postgresql"
  url               = env("DATABASE_URL")
  directUrl         = env("DATABASE_DIRECT_URL")
  shadowDatabaseUrl = env("SHADOW_DATABASE_URL")
}

enum Role {
  USER
  ADMIN
}

enum PostQueueStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}

enum QueueLocationScope {
  CITY
  PROVINCE
}

enum PostAnalysisStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}

enum NotificationStatus {
  PENDING
  SENT
  FAILED
}

enum PhoneFetchStatus {
  PENDING
  IN_PROGRESS
  DONE
  FAILED
}

model User {
  id                 String   @id @default(uuid())
  phone              String   @unique
  email              String?  @unique
  firstName          String?
  lastName           String?
  cityId             Int?
  city               City?    @relation(fields: [cityId], references: [id], onUpdate: Cascade, onDelete: SetNull)
  profileImageUrl    String?
  role               Role     @default(USER)
  isActive           Boolean  @default(true)
  hashedRefreshToken String?
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt
  ringBinderFolders  RingBinderFolder[]
  postNotes          DivarPostNote[]
  savedFilters       SavedFilter[]
  notifications      Notification[]
  pushSubscriptions  PushSubscription[]

  @@index([cityId])
}

model City {
  id           Int               @id
  slug         String            @unique
  name         String
  provinceId   Int
  province     Province          @relation(fields: [provinceId], references: [id], onUpdate: Cascade, onDelete: Restrict)
  allowPosting Boolean           @default(false)
  createdAt    DateTime          @default(now())
  updatedAt    DateTime          @default(now()) @updatedAt
  users        User[]
  districts    District[]
  queuedPosts  PostToReadQueue[] @relation("CityPostQueue")
  posts        DivarPost[]

  @@unique([name, provinceId])
  @@index([provinceId])
}

model Province {
  id           Int               @id
  slug         String            @unique
  name         String            @unique
  allowPosting Boolean           @default(false)
  createdAt    DateTime          @default(now())
  updatedAt    DateTime          @default(now()) @updatedAt
  cities       City[]
  queuedPosts  PostToReadQueue[] @relation("ProvincePostQueue")
  posts        DivarPost[]
}

model District {
  id        Int      @id
  slug      String
  name      String
  cityId    Int
  city      City     @relation(fields: [cityId], references: [id], onUpdate: Cascade, onDelete: Cascade)
  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt
  posts     DivarPost[]

  @@unique([cityId, slug])
  @@unique([cityId, name])
  @@index([slug])
}

model DivarCategory {
  id           String               @id @default(uuid())
  slug         String               @unique
  name         String
  displayPath  String
  path         String               @unique
  parentId     String?
  parent       DivarCategory?       @relation("DivarCategoryHierarchy", fields: [parentId], references: [id], onDelete: SetNull, onUpdate: Cascade)
  children     DivarCategory[]      @relation("DivarCategoryHierarchy")
  depth        Int
  position     Int
  isActive     Boolean              @default(true)
  allowPosting Boolean              @default(false)
  filters      DivarCategoryFilter?
  queuedPosts  PostToReadQueue[]    @relation("CategoryPostQueue")
  posts        DivarPost[]
  createdAt    DateTime             @default(now())
  updatedAt    DateTime             @default(now()) @updatedAt

  @@index([parentId])
  @@index([isActive])
}

model DivarCategoryFilter {
  id         String        @id @default(uuid())
  categoryId String        @unique
  category   DivarCategory @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  payload    Json
  normalizedOptions Json?  @default("{}")
  createdAt  DateTime      @default(now())
  updatedAt  DateTime      @default(now()) @updatedAt
}

model PostToReadQueue {
  id              String             @id @default(uuid())
  source          String             @default("DIVAR")
  externalId      String
  categoryId      String?
  category        DivarCategory?     @relation("CategoryPostQueue", fields: [categoryId], references: [id], onDelete: SetNull)
  categorySlug    String
  locationScope   QueueLocationScope @default(CITY)
  provinceId      Int?
  province        Province?          @relation("ProvincePostQueue", fields: [provinceId], references: [id], onDelete: SetNull)
  cityId          Int?
  city            City?              @relation("CityPostQueue", fields: [cityId], references: [id], onDelete: SetNull)
  payload         Json?
  status          PostQueueStatus    @default(PENDING)
  fetchAttempts   Int                @default(0)
  lastFetchedAt   DateTime?
  requestedAt     DateTime           @default(now())
  createdAt       DateTime           @default(now())
  updatedAt       DateTime           @default(now()) @updatedAt
  analyzeJob      PostToAnalyzeQueue?
  normalizedPost  DivarPost?

  @@unique([source, externalId])
  @@index([categoryId])
  @@index([provinceId])
  @@index([cityId])
}

model PostToAnalyzeQueue {
  id           String             @id @default(uuid())
  source       String             @default("DIVAR")
  externalId   String
  readQueueId  String             @unique
  readQueue    PostToReadQueue    @relation(fields: [readQueueId], references: [id], onDelete: Cascade)
  payload      Json
  status       PostAnalysisStatus @default(PENDING)
  errorMessage String?
  retryCount   Int                @default(0)
  createdAt    DateTime           @default(now())
  updatedAt    DateTime           @default(now()) @updatedAt

  @@unique([source, externalId])
}

model DivarPost {
  id              String             @id @default(uuid())
  source          String             @default("DIVAR")
  externalId      String             @unique
  readQueueId     String             @unique
  readQueue       PostToReadQueue    @relation(fields: [readQueueId], references: [id], onDelete: Cascade)
  categoryId      String?
  category        DivarCategory?     @relation(fields: [categoryId], references: [id], onDelete: SetNull)
  categorySlug    String
  cat1            String?
  cat2            String?
  cat3            String?
  title           String?
  seoTitle        String?
  seoDescription  String?
  displayTitle    String?
  displaySubtitle String?
  shareTitle      String?
  shareUrl        String?
  permalink       String?
  description     String?
  contactUuid     String?
  phoneNumber     String?
  businessRef     String?
  businessType    String?
  conversionType  String?
  listedAt        DateTime?
  expiresAt       DateTime?
  publishedAt     DateTime?
  publishedAtJalali String?
  status          PostAnalysisStatus @default(PENDING)
  priceTotal      Decimal?           @db.Decimal(18, 0)
  pricePerSquare  Decimal?           @db.Decimal(18, 0)
  depositAmount   Decimal?           @db.Decimal(18, 0)
  rentAmount      Decimal?           @db.Decimal(18, 0)
  dailyRateNormal Decimal?           @db.Decimal(18, 0)
  dailyRateWeekend Decimal?          @db.Decimal(18, 0)
  dailyRateHoliday Decimal?          @db.Decimal(18, 0)
  extraPersonFee  Decimal?           @db.Decimal(18, 0)
  area            Int?
  areaLabel       String?
  landArea        Int?
  landAreaLabel   String?
  rooms           Int?
  roomsLabel      String?
  floor           Int?
  floorLabel      String?
  floorsCount     Int?
  unitPerFloor    Int?
  yearBuilt       Int?
  yearBuiltLabel  String?
  capacity        Int?
  capacityLabel   String?
  hasParking      Boolean?
  hasElevator     Boolean?
  hasWarehouse    Boolean?
  hasBalcony      Boolean?
  isRebuilt       Boolean?
  photosVerified  Boolean?
  imageCount      Int?
  latitude        Decimal?           @db.Decimal(12, 8)
  longitude       Decimal?           @db.Decimal(12, 8)
  provinceId      Int?
  province        Province?          @relation(fields: [provinceId], references: [id], onDelete: SetNull)
  provinceName    String?
  cityId          Int?
  city            City?              @relation(fields: [cityId], references: [id], onDelete: SetNull)
  citySlug        String?
  cityName        String?
  districtId      Int?
  district        District?          @relation(fields: [districtId], references: [id], onDelete: SetNull)
  districtSlug    String?
  districtName    String?
  rawPayload      Json
  createdAt       DateTime           @default(now())
  updatedAt       DateTime           @default(now()) @updatedAt
  phoneFetchStatus     PhoneFetchStatus @default(PENDING)
  phoneFetchLockedUntil DateTime?
  phoneFetchLeaseId     String?
  phoneFetchWorker      String?
  phoneFetchAttemptCount Int            @default(0)
  phoneFetchLastError    String?
  medias          DivarPostMedia[]
  attributes      DivarPostAttribute[]
  savedInFolders  RingBinderFolderPost[]
  notes           DivarPostNote[]
  notifications   Notification[]
  notificationsChecked Boolean  @default(false)
  notificationsCheckedAt DateTime?

  @@index([categoryId])
  @@index([categorySlug])
  @@index([cityId])
  @@index([districtId])
  @@index([status])
  @@index([createdAt])
  @@index([businessRef])
  @@index([phoneNumber])
  @@index([contactUuid, phoneNumber])
  @@index([notificationsChecked, createdAt])
}

model DivarPostMedia {
  id           String    @id @default(uuid())
  postId       String
  post         DivarPost @relation(fields: [postId], references: [id], onDelete: Cascade)
  position     Int
  url          String
  thumbnailUrl String?
  localUrl     String?
  localThumbnailUrl String?
  alt          String?
  metadata     Json?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @default(now()) @updatedAt

  @@index([postId])
}

model DivarPostAttribute {
  id          String    @id @default(uuid())
  postId      String
  post        DivarPost @relation(fields: [postId], references: [id], onDelete: Cascade)
  key         String
  label       String?
  type        String?
  stringValue String?
  numberValue Decimal?  @db.Decimal(18, 2)
  boolValue   Boolean?
  unit        String?
  rawValue    Json?
  createdAt   DateTime  @default(now())

  @@index([postId])
  @@index([key])
}

model SubscriptionPackage {
  id              String   @id @default(uuid())
  title           String
  description     String?
  imageUrl        String?
  durationDays    Int
  freeDays        Int      @default(0)
  includedUsers   Int      @default(1)
  actualPrice     Decimal  @db.Decimal(12, 2)
  discountedPrice Decimal  @db.Decimal(12, 2)
  savedFiltersLimit Int    @default(5)
  isActive        Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([isActive])
}

model SavedFilter {
  id        String   @id @default(uuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  name      String
  payload   Json
  notificationsEnabled Boolean @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  notifications Notification[]

  @@unique([userId, name])
  @@index([userId, createdAt])
}

model RingBinderFolder {
  id        String   @id @default(uuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  name      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  deletedAt DateTime?
  posts     RingBinderFolderPost[]

  @@unique([userId, name, deletedAt])
  @@index([userId])
  @@index([userId, deletedAt])
}

model RingBinderFolderPost {
  id        String             @id @default(uuid())
  folderId  String
  postId    String
  folder    RingBinderFolder   @relation(fields: [folderId], references: [id], onDelete: Cascade)
  post      DivarPost          @relation(fields: [postId], references: [id], onDelete: Cascade)
  createdAt DateTime           @default(now())

  @@unique([folderId, postId])
  @@index([postId])
}

model DivarPostNote {
  id        String   @id @default(uuid())
  userId    String
  postId    String
  content   String   @db.Text
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  post      DivarPost @relation(fields: [postId], references: [id], onDelete: Cascade)

  @@unique([userId, postId])
  @@index([postId])
}

model Notification {
  id            String             @id @default(uuid())
  userId        String
  user          User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  savedFilterId String
  savedFilter   SavedFilter        @relation(fields: [savedFilterId], references: [id], onDelete: Cascade)
  postId        String
  post          DivarPost          @relation(fields: [postId], references: [id], onDelete: Cascade)
  status        NotificationStatus @default(PENDING)
  message       String?
  payload       Json?
  attemptCount  Int                @default(0)
  nextAttemptAt DateTime           @default(now())
  sentAt        DateTime?
  failedAt      DateTime?
  createdAt     DateTime           @default(now())
  updatedAt     DateTime           @updatedAt

  @@unique([userId, savedFilterId, postId])
  @@index([userId, status, nextAttemptAt])
  @@index([nextAttemptAt])
  @@index([postId])
}

model PushSubscription {
  id         String   @id @default(uuid())
  userId     String
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  endpoint   String   @unique
  p256dh     String
  auth       String
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@index([userId])
}

model AdminDivarSession {
  id        String   @id @default(uuid())
  phone     String   @unique
  jwt       String
  active    Boolean  @default(true)
  locked    Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model BusinessPhoneCache {
  id           String   @id @default(uuid())
  businessRef  String   @unique
  phoneNumber  String?
  fetchedAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  lockedUntil  DateTime?
  title        String?
  titleFetchedAt DateTime?
}
