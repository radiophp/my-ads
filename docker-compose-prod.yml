version: '3.9'

x-deploy-defaults: &deploy_defaults
  restart_policy:
    condition: on-failure
    delay: 5s
    max_attempts: 3
    window: 30s
  update_config:
    parallelism: 1
    order: start-first
  rollback_config:
    parallelism: 1
    order: stop-first

services:
  postgres:
    image: postgres:16-alpine
    environment:
      POSTGRES_DB: ${POSTGRES_DB:-my_ads}
      POSTGRES_USER: ${POSTGRES_USER:-postgres}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:?POSTGRES_PASSWORD not set}
      PGPORT: ${POSTGRES_INTERNAL_PORT:-5432}
    ports:
      - target: ${POSTGRES_INTERNAL_PORT:-5432}
        published: ${POSTGRES_PUBLISHED_PORT:-6301}
        protocol: tcp
        mode: host
    volumes:
      - postgres_data:/var/lib/postgresql/data
    networks:
      - app_net
    deploy:
      <<: *deploy_defaults
      replicas: 1
      placement:
        constraints:
          - node.role == manager

  redis:
    image: redis:7-alpine
    command:
      [
        "redis-server",
        "--port",
        "${REDIS_PORT:-6379}"
      ]
    networks:
      - app_net
    deploy:
      <<: *deploy_defaults
      replicas: 1

  rabbitmq:
    image: rabbitmq:3.13-management
    environment:
      RABBITMQ_DEFAULT_USER: ${RABBITMQ_USERNAME:-guest}
      RABBITMQ_DEFAULT_PASS: ${RABBITMQ_PASSWORD:-guest}
    volumes:
      - rabbitmq_data:/var/lib/rabbitmq
    networks:
      - app_net
    deploy:
      <<: *deploy_defaults
      replicas: 1

  minio:
    image: minio/minio:RELEASE.2025-02-28T09-55-16Z
    command:
      [
        "server",
        "/data",
        "--console-address",
        ":${MINIO_CONSOLE_PORT:-9001}",
        "--address",
        ":${MINIO_PORT:-9000}"
      ]
    environment:
      MINIO_ROOT_USER: ${MINIO_ACCESS_KEY:?MINIO_ACCESS_KEY not set}
      MINIO_ROOT_PASSWORD: ${MINIO_SECRET_KEY:?MINIO_SECRET_KEY not set}
    volumes:
      - minio_data:/data
    ports:
      - target: ${MINIO_PORT:-9000}
        published: ${MINIO_PORT:-9000}
        protocol: tcp
        mode: ingress
      - target: ${MINIO_CONSOLE_PORT:-9001}
        published: ${MINIO_CONSOLE_PORT:-9001}
        protocol: tcp
        mode: ingress
    networks:
      - app_net
    deploy:
      <<: *deploy_defaults
      replicas: 1

  api:
    image: ghcr.io/radiophp/my-ads-api:latest
    environment:
      NODE_ENV: production
      APP_HOST: 0.0.0.0
      APP_PORT: ${APP_PORT:-6200}
      APP_GLOBAL_PREFIX: ${APP_GLOBAL_PREFIX:-api}
      DATABASE_URL: ${DATABASE_URL:-postgresql://${POSTGRES_USER:-postgres}:${POSTGRES_PASSWORD:-postgres}@postgres:${POSTGRES_INTERNAL_PORT:-5432}/${POSTGRES_DB:-my_ads}?schema=public}
      DATABASE_DIRECT_URL: ${DATABASE_DIRECT_URL:-postgresql://${POSTGRES_USER:-postgres}:${POSTGRES_PASSWORD:-postgres}@postgres:${POSTGRES_INTERNAL_PORT:-5432}/${POSTGRES_DB:-my_ads}?schema=public}
      REDIS_HOST: ${REDIS_HOST:-redis}
      REDIS_PORT: ${REDIS_PORT:-6379}
      REDIS_DB: ${REDIS_DB:-0}
      REDIS_TLS: ${REDIS_TLS:-false}
      REDIS_KEY_PREFIX: ${REDIS_KEY_PREFIX:-my-ads:}
      JWT_ACCESS_TOKEN_SECRET: ${JWT_ACCESS_TOKEN_SECRET:?JWT_ACCESS_TOKEN_SECRET not set}
      JWT_REFRESH_TOKEN_SECRET: ${JWT_REFRESH_TOKEN_SECRET:?JWT_REFRESH_TOKEN_SECRET not set}
      JWT_ACCESS_TOKEN_TTL: ${JWT_ACCESS_TOKEN_TTL:-900s}
      JWT_REFRESH_TOKEN_TTL: ${JWT_REFRESH_TOKEN_TTL:-7d}
      CORS_ORIGIN: ${CORS_ORIGIN:-https://mahan.radiophp.observer}
      RATE_LIMIT_TTL: ${RATE_LIMIT_TTL:-60}
      RATE_LIMIT_MAX: ${RATE_LIMIT_MAX:-100}
      OTP_TTL_SECONDS: ${OTP_TTL_SECONDS:-300}
      OTP_DIGITS: ${OTP_DIGITS:-6}
      OTP_SENDER_BASE_URL: ${OTP_SENDER_BASE_URL:-}
      OTP_SENDER_API_KEY: ${OTP_SENDER_API_KEY:-}
      RABBITMQ_URL: ${RABBITMQ_URL:-amqp://${RABBITMQ_USERNAME:-guest}:${RABBITMQ_PASSWORD:-guest}@rabbitmq:5672}
      RABBITMQ_QUEUE_PREFIX: ${RABBITMQ_QUEUE_PREFIX:-my-ads}
      RABBITMQ_PREFETCH: ${RABBITMQ_PREFETCH:-10}
      RABBITMQ_HEARTBEAT: ${RABBITMQ_HEARTBEAT:-60}
      RABBITMQ_RECONNECT_SECONDS: ${RABBITMQ_RECONNECT_SECONDS:-5}
      MINIO_ENDPOINT: ${MINIO_ENDPOINT:-minio}
      MINIO_PORT: ${MINIO_PORT:-9000}
      MINIO_CONSOLE_PORT: ${MINIO_CONSOLE_PORT:-9001}
      MINIO_USE_SSL: ${MINIO_USE_SSL:-false}
      MINIO_ACCESS_KEY: ${MINIO_ACCESS_KEY:?MINIO_ACCESS_KEY not set}
      MINIO_SECRET_KEY: ${MINIO_SECRET_KEY:?MINIO_SECRET_KEY not set}
      MINIO_BUCKET: ${MINIO_BUCKET:-upload}
      MINIO_REGION: ${MINIO_REGION:-us-east-1}
      OTEL_ENABLED: ${OTEL_ENABLED:-false}
      OTEL_SERVICE_NAME: ${OTEL_SERVICE_NAME:-my-ads-api}
      OTEL_EXPORTER_OTLP_ENDPOINT: ${OTEL_EXPORTER_OTLP_ENDPOINT:-http://otel-collector:4318}
      OTEL_EXPORTER_OTLP_HEADERS: ${OTEL_EXPORTER_OTLP_HEADERS:-}
      OTEL_LOG_LEVEL: ${OTEL_LOG_LEVEL:-error}
      LOG_LEVEL: ${LOG_LEVEL:-info}
      LOG_PRETTY: ${LOG_PRETTY:-false}
      PRISMA_LOG_QUERIES: ${PRISMA_LOG_QUERIES:-false}
      NEXT_UI_PORT: ${NEXT_UI_PORT:-6005}
      NEXT_PUBLIC_APP_URL: ${NEXT_PUBLIC_APP_URL:-https://mahan.radiophp.observer}
      NEXT_PUBLIC_API_BASE_URL: ${NEXT_PUBLIC_API_BASE_URL:-https://mahan.radiophp.observer/api}
    ports:
      - target: ${APP_PORT:-6200}
        published: ${APP_PORT:-6200}
        protocol: tcp
        mode: ingress
    networks:
      - app_net
    depends_on:
      - postgres
      - redis
      - rabbitmq
      - minio
    deploy:
      <<: *deploy_defaults
      replicas: ${API_REPLICAS:-2}
      placement:
        constraints:
          - node.role == manager

  api-cron:
    image: ghcr.io/radiophp/my-ads-api:latest
    command:
      [
        "node",
        "dist/scripts/run-cron-scheduler.js"
      ]
    environment:
      NODE_ENV: production
      ENABLE_CRON_JOBS: 'true'
      APP_HOST: 0.0.0.0
      APP_PORT: ${APP_PORT:-6300}
      APP_GLOBAL_PREFIX: ${APP_GLOBAL_PREFIX:-api}
      DATABASE_URL: ${DATABASE_URL:-postgresql://${POSTGRES_USER:-postgres}:${POSTGRES_PASSWORD:-postgres}@postgres:${POSTGRES_INTERNAL_PORT:-5432}/${POSTGRES_DB:-my_ads}?schema=public}
      DATABASE_DIRECT_URL: ${DATABASE_DIRECT_URL:-postgresql://${POSTGRES_USER:-postgres}:${POSTGRES_PASSWORD:-postgres}@postgres:${POSTGRES_INTERNAL_PORT:-5432}/${POSTGRES_DB:-my_ads}?schema=public}
      REDIS_HOST: ${REDIS_HOST:-redis}
      REDIS_PORT: ${REDIS_PORT:-6379}
      REDIS_DB: ${REDIS_DB:-0}
      REDIS_TLS: ${REDIS_TLS:-false}
      REDIS_KEY_PREFIX: ${REDIS_KEY_PREFIX:-my-ads:}
      JWT_ACCESS_TOKEN_SECRET: ${JWT_ACCESS_TOKEN_SECRET:?JWT_ACCESS_TOKEN_SECRET not set}
      JWT_REFRESH_TOKEN_SECRET: ${JWT_REFRESH_TOKEN_SECRET:?JWT_REFRESH_TOKEN_SECRET not set}
      JWT_ACCESS_TOKEN_TTL: ${JWT_ACCESS_TOKEN_TTL:-900s}
      JWT_REFRESH_TOKEN_TTL: ${JWT_REFRESH_TOKEN_TTL:-7d}
      CORS_ORIGIN: ${CORS_ORIGIN:-https://mahan.radiophp.observer}
      RATE_LIMIT_TTL: ${RATE_LIMIT_TTL:-60}
      RATE_LIMIT_MAX: ${RATE_LIMIT_MAX:-100}
      OTP_TTL_SECONDS: ${OTP_TTL_SECONDS:-300}
      OTP_DIGITS: ${OTP_DIGITS:-6}
      OTP_SENDER_BASE_URL: ${OTP_SENDER_BASE_URL:-}
      OTP_SENDER_API_KEY: ${OTP_SENDER_API_KEY:-}
      RABBITMQ_URL: ${RABBITMQ_URL:-amqp://${RABBITMQ_USERNAME:-guest}:${RABBITMQ_PASSWORD:-guest}@rabbitmq:5672}
      RABBITMQ_QUEUE_PREFIX: ${RABBITMQ_QUEUE_PREFIX:-my-ads}
      RABBITMQ_PREFETCH: ${RABBITMQ_PREFETCH:-10}
      RABBITMQ_HEARTBEAT: ${RABBITMQ_HEARTBEAT:-60}
      RABBITMQ_RECONNECT_SECONDS: ${RABBITMQ_RECONNECT_SECONDS:-5}
      MINIO_ENDPOINT: ${MINIO_ENDPOINT:-minio}
      MINIO_PORT: ${MINIO_PORT:-9000}
      MINIO_CONSOLE_PORT: ${MINIO_CONSOLE_PORT:-9001}
      MINIO_USE_SSL: ${MINIO_USE_SSL:-false}
      MINIO_ACCESS_KEY: ${MINIO_ACCESS_KEY:?MINIO_ACCESS_KEY not set}
      MINIO_SECRET_KEY: ${MINIO_SECRET_KEY:?MINIO_SECRET_KEY not set}
      MINIO_BUCKET: ${MINIO_BUCKET:-upload}
      MINIO_REGION: ${MINIO_REGION:-us-east-1}
      OTEL_ENABLED: ${OTEL_ENABLED:-false}
      OTEL_SERVICE_NAME: ${OTEL_SERVICE_NAME:-my-ads-api}
      OTEL_EXPORTER_OTLP_ENDPOINT: ${OTEL_EXPORTER_OTLP_ENDPOINT:-http://otel-collector:4318}
      OTEL_EXPORTER_OTLP_HEADERS: ${OTEL_EXPORTER_OTLP_HEADERS:-}
      OTEL_LOG_LEVEL: ${OTEL_LOG_LEVEL:-error}
      LOG_LEVEL: ${LOG_LEVEL:-info}
      LOG_PRETTY: ${LOG_PRETTY:-false}
      PRISMA_LOG_QUERIES: ${PRISMA_LOG_QUERIES:-false}
      NEXT_UI_PORT: ${NEXT_UI_PORT:-6005}
      NEXT_PUBLIC_APP_URL: ${NEXT_PUBLIC_APP_URL:-https://mahan.radiophp.observer}
      NEXT_PUBLIC_API_BASE_URL: ${NEXT_PUBLIC_API_BASE_URL:-https://mahan.radiophp.observer/api}
    depends_on:
      - postgres
      - redis
      - rabbitmq
      - minio
    networks:
      - app_net
    deploy:
      <<: *deploy_defaults
      replicas: ${API_CRON_REPLICAS:-1}

  tileserver:
    image: maptiler/tileserver-gl:v4.8.0
    command: ["--mbtiles", "/data/iran.mbtiles", "--port", "8080"]
    ports:
      - target: 8080
        published: ${MAP_TILES_PORT:-8235}
        protocol: tcp
        mode: ingress
    volumes:
      - type: bind
        source: ${MAP_TILES_PATH:-/var/lib/my-ads/maps}
        target: /data
        read_only: true
    networks:
      - app_net
    deploy:
      <<: *deploy_defaults
      replicas: 1
      placement:
        constraints:
          - node.role == manager

  otel-collector:
    image: otel/opentelemetry-collector-contrib:0.99.0
    command: ["--config=/etc/otel-collector.yaml"]
    volumes:
      - ./observability/otel-collector-config.yaml:/etc/otel-collector.yaml:ro
    ports:
      - target: ${OTEL_COLLECTOR_HTTP_PORT:-6317}
        published: ${OTEL_COLLECTOR_HTTP_PORT:-6317}
        protocol: tcp
        mode: ingress
    environment:
      OTEL_COLLECTOR_HTTP_PORT: ${OTEL_COLLECTOR_HTTP_PORT:-6317}
      OTEL_COLLECTOR_GRPC_PORT: ${OTEL_COLLECTOR_GRPC_PORT:-6318}
      TEMPO_GRPC_PORT: ${TEMPO_GRPC_PORT:-6321}
    networks:
      - app_net
    deploy:
      <<: *deploy_defaults
      replicas: 1

  loki:
    image: grafana/loki:2.9.3
    command: ["-config.file=/etc/loki/local-config.yaml"]
    volumes:
      - ./observability/loki-config.yaml:/etc/loki/local-config.yaml:ro
      - loki_data:/var/loki
    ports:
      - target: ${LOKI_PORT:-6319}
        published: ${LOKI_PORT:-6319}
        protocol: tcp
        mode: ingress
    environment:
      LOKI_PORT: ${LOKI_PORT:-6319}
    networks:
      - app_net
    deploy:
      <<: *deploy_defaults
      replicas: 1

  promtail:
    image: grafana/promtail:2.9.3
    command: ["--config.file=/etc/promtail/config.yaml"]
    volumes:
      - ./observability/promtail-config.yaml:/etc/promtail/config.yaml:ro
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - promtail_positions:/var/lib/promtail
    depends_on:
      - loki
    networks:
      - app_net
    deploy:
      <<: *deploy_defaults
      replicas: 1

  tempo:
    image: grafana/tempo:2.4.1
    command: ["-config.file=/etc/tempo.yaml"]
    volumes:
      - ./observability/tempo.yaml:/etc/tempo.yaml:ro
      - tempo_data:/var/tempo
    ports:
      - target: ${TEMPO_PORT:-6320}
        published: ${TEMPO_PORT:-6320}
        protocol: tcp
        mode: ingress
    environment:
      TEMPO_PORT: ${TEMPO_PORT:-6320}
      TEMPO_GRPC_PORT: ${TEMPO_GRPC_PORT:-6321}
    networks:
      - app_net
    deploy:
      <<: *deploy_defaults
      replicas: 1

  prometheus:
    image: prom/prometheus:v2.49.1
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--web.console.libraries=/usr/share/prometheus/console_libraries'
      - '--web.console.templates=/usr/share/prometheus/consoles'
      - '--web.listen-address=:${PROMETHEUS_PORT:-6322}'
    volumes:
      - ./observability/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - ./observability/prometheus-alerts.yml:/etc/prometheus/alerts/health-alerts.yml:ro
      - prometheus_data:/prometheus
    ports:
      - target: ${PROMETHEUS_PORT:-6322}
        published: ${PROMETHEUS_PORT:-6322}
        protocol: tcp
        mode: ingress
    environment:
      PROMETHEUS_PORT: ${PROMETHEUS_PORT:-6322}
    networks:
      - app_net
    deploy:
      <<: *deploy_defaults
      replicas: 1

  grafana:
    image: grafana/grafana:10.4.1
    environment:
      GF_SECURITY_ADMIN_USER: admin
      GF_SECURITY_ADMIN_PASSWORD: admin
      GF_FEATURE_TOGGLES_ENABLE: traceqlEditor
      GF_SERVER_HTTP_PORT: ${GRAFANA_PORT:-6323}
      GF_PATHS_PROVISIONING: /etc/grafana/provisioning
    volumes:
      - grafana_data:/var/lib/grafana
      - ./observability/grafana/provisioning/datasources:/etc/grafana/provisioning/datasources
      - ./observability/grafana/provisioning/dashboards:/var/lib/grafana/dashboards
    depends_on:
      - loki
      - prometheus
      - tempo
    ports:
      - target: ${GRAFANA_PORT:-6323}
        published: ${GRAFANA_PORT:-6323}
        protocol: tcp
        mode: ingress
    networks:
      - app_net
    deploy:
      <<: *deploy_defaults
      replicas: 1

  telegram-bot:
    image: ghcr.io/radiophp/my-ads-api:latest
    command:
      [
        "node",
        "dist/scripts/run-telegram-bot.js"
      ]
    environment:
      NODE_ENV: production
      APP_HOST: 0.0.0.0
      APP_PORT: ${APP_PORT:-6200}
      DATABASE_URL: ${DATABASE_URL:-postgresql://${POSTGRES_USER:-postgres}:${POSTGRES_PASSWORD:-postgres}@postgres:${POSTGRES_INTERNAL_PORT:-5432}/${POSTGRES_DB:-my_ads}?schema=public}
      DATABASE_DIRECT_URL: ${DATABASE_DIRECT_URL:-postgresql://${POSTGRES_USER:-postgres}:${POSTGRES_PASSWORD:-postgres}@postgres:${POSTGRES_INTERNAL_PORT:-5432}/${POSTGRES_DB:-my_ads}?schema=public}
      REDIS_HOST: ${REDIS_HOST:-redis}
      REDIS_PORT: ${REDIS_PORT:-6379}
      RABBITMQ_URL: ${RABBITMQ_URL:-amqp://${RABBITMQ_USERNAME:-guest}:${RABBITMQ_PASSWORD:-guest}@rabbitmq:5672}
      JWT_ACCESS_TOKEN_SECRET: ${JWT_ACCESS_TOKEN_SECRET:?JWT_ACCESS_TOKEN_SECRET not set}
      JWT_REFRESH_TOKEN_SECRET: ${JWT_REFRESH_TOKEN_SECRET:?JWT_REFRESH_TOKEN_SECRET not set}
      TELEGRAM_BOT_TOKEN: ${TELEGRAM_BOT_TOKEN:?TELEGRAM_BOT_TOKEN not set}
      TELEGRAM_BOT_AUTOSTART: 'false'
    depends_on:
      - postgres
      - redis
      - rabbitmq
    networks:
      - app_net
    deploy:
      <<: *deploy_defaults
      replicas: ${TELEGRAM_BOT_REPLICAS:-1}
      placement:
        constraints:
          - node.role == manager

  ui:
    image: ghcr.io/radiophp/my-ads-ui:latest
    environment:
      NODE_ENV: production
      NEXT_UI_PORT: ${NEXT_UI_PORT:-6005}
      PORT: ${NEXT_UI_PORT:-6005}
      NEXT_PUBLIC_APP_URL: ${NEXT_PUBLIC_APP_URL:-https://mahanfile.com}
      NEXT_PUBLIC_API_BASE_URL: ${NEXT_PUBLIC_API_BASE_URL:-https://mahanfile.com/api}
      NEXT_PUBLIC_ANALYTICS_WRITE_KEY: ${NEXT_PUBLIC_ANALYTICS_WRITE_KEY:-}
    depends_on:
      - api
    ports:
      - target: ${NEXT_UI_PORT:-6005}
        published: ${NEXT_UI_PORT:-6005}
        protocol: tcp
        mode: ingress
    networks:
      - app_net
    deploy:
      <<: *deploy_defaults
      replicas: ${UI_REPLICAS:-2}
      placement:
        constraints:
          - node.role == manager

networks:
  app_net:
    driver: overlay
    attachable: true

volumes:
  postgres_data:
  minio_data:
  loki_data:
  tempo_data:
  prometheus_data:
  grafana_data:
  promtail_positions:
  rabbitmq_data:
