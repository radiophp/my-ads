name: CI

on:
  push:
  pull_request:

jobs:
  server-lint:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Use Node.js 22
        uses: actions/setup-node@v6
        with:
          node-version: 22
          cache: 'npm'
          cache-dependency-path: server/package-lock.json

      - name: Install dependencies
        working-directory: server
        run: npm install

      - name: Run lint
        working-directory: server
        run: ESLINT_USE_FLAT_CONFIG=false npm run lint

  server-typecheck:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Use Node.js 22
        uses: actions/setup-node@v6
        with:
          node-version: 22
          cache: 'npm'
          cache-dependency-path: server/package-lock.json

      - name: Install dependencies
        working-directory: server
        run: npm install

      - name: Type check
        working-directory: server
        run: npm run typecheck

  server-test:
    runs-on: ubuntu-latest
    needs: server-typecheck
    services:
      postgres:
        image: postgres:16-alpine
        ports:
          - 6201:5432
        env:
          POSTGRES_DB: my_ads
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
        options: >-
          --health-cmd "pg_isready -U postgres" --health-interval 10s --health-timeout 5s --health-retries 5
      redis:
        image: redis:7-alpine
        ports:
          - 6202:6379
        options: >-
          --health-cmd "redis-cli ping" --health-interval 10s --health-timeout 5s --health-retries 5
    env:
      DATABASE_URL: postgresql://postgres:postgres@localhost:6201/my_ads?schema=public
      DATABASE_DIRECT_URL: postgresql://postgres:postgres@localhost:6201/my_ads?schema=public
      REDIS_HOST: localhost
      REDIS_PORT: 6202
      JWT_ACCESS_TOKEN_SECRET: github-access-secret
      JWT_REFRESH_TOKEN_SECRET: github-refresh-secret
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Use Node.js 22
        uses: actions/setup-node@v6
        with:
          node-version: 22
          cache: 'npm'
          cache-dependency-path: server/package-lock.json

      - name: Install dependencies
        working-directory: server
        run: npm install

      - name: Generate Prisma Client
        working-directory: server
        run: npm run prisma:generate

      - name: Apply database schema
        working-directory: server
        run: npx prisma migrate deploy

      - name: Run unit tests
        working-directory: server
        run: npm test -- --runInBand

      - name: Run e2e tests
        working-directory: server
        run: npm run test:e2e

  server-build:
    runs-on: ubuntu-latest
    needs: server-test
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Use Node.js 22
        uses: actions/setup-node@v6
        with:
          node-version: 22
          cache: 'npm'
          cache-dependency-path: server/package-lock.json

      - name: Install dependencies
        working-directory: server
        run: npm install

      - name: Build
        working-directory: server
        run: npm run build

  ui-lint:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ui
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Use Node.js 22
        uses: actions/setup-node@v6
        with:
          node-version: 22
          cache: 'npm'
          cache-dependency-path: ui/package-lock.json

      - name: Install dependencies
        run: npm install

      - name: Run lint
        run: npm run lint

  ui-typecheck:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ui
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Use Node.js 22
        uses: actions/setup-node@v6
        with:
          node-version: 22
          cache: 'npm'
          cache-dependency-path: ui/package-lock.json

      - name: Install dependencies
        run: npm install

      - name: Type check
        run: npm run typecheck

  ui-test:
    runs-on: ubuntu-latest
    needs: ui-typecheck
    env:
      NEXT_UI_PORT: 6005
    defaults:
      run:
        working-directory: ui
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Use Node.js 22
        uses: actions/setup-node@v6
        with:
          node-version: 22
          cache: 'npm'
          cache-dependency-path: ui/package-lock.json

      - name: Install dependencies
        run: npm install

      - name: Run unit tests
        run: npm test -- --run

      - name: Install Playwright browsers
        run: npx playwright install --with-deps

      - name: Run Playwright tests
        if: ${{ false }}
        run: npm run test:e2e -- --reporter=list
        env:
          PLAYWRIGHT_BASE_URL: http://localhost:6005
          NEXT_UI_PORT: 6005

  ui-build:
    runs-on: ubuntu-latest
    needs: ui-test
    defaults:
      run:
        working-directory: ui
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Use Node.js 22
        uses: actions/setup-node@v6
        with:
          node-version: 22
          cache: 'npm'
          cache-dependency-path: ui/package-lock.json

      - name: Install dependencies
        run: npm install

      - name: Build project
        run: npm run build

  publish-images:
    runs-on: ubuntu-latest
    needs:
      - server-build
      - ui-build
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    permissions:
      contents: read
      packages: write
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Derive image namespace
        id: vars
        run: echo "owner=${GITHUB_REPOSITORY_OWNER,,}" >> "$GITHUB_OUTPUT"

      - name: Build and push API image
        uses: docker/build-push-action@v6
        with:
          context: server
          file: server/Dockerfile
          push: true
          tags: |
            ghcr.io/${{ steps.vars.outputs.owner }}/my-ads-api:${{ github.sha }}
            ghcr.io/${{ steps.vars.outputs.owner }}/my-ads-api:latest

      - name: Build and push UI image
        uses: docker/build-push-action@v6
        with:
          context: ui
          file: ui/Dockerfile
          push: true
          tags: |
            ghcr.io/${{ steps.vars.outputs.owner }}/my-ads-ui:${{ github.sha }}
            ghcr.io/${{ steps.vars.outputs.owner }}/my-ads-ui:latest

  deploy:
    runs-on:
      - self-hosted
      - linux
      - x64
    needs: publish-images
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    permissions:
      contents: read
    env:
      STACK_NAME: ${{ vars.DEPLOY_STACK_NAME || 'my-ads' }}
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Validate deployment configuration
        env:
          STACK_NAME: ${{ env.STACK_NAME }}
          GHCR_TOKEN: ${{ secrets.GHCR_TOKEN }}
          POSTGRES_PASSWORD: ${{ secrets.POSTGRES_PASSWORD }}
          MINIO_ACCESS_KEY: ${{ secrets.MINIO_ACCESS_KEY }}
          MINIO_SECRET_KEY: ${{ secrets.MINIO_SECRET_KEY }}
          JWT_ACCESS_TOKEN_SECRET: ${{ secrets.JWT_ACCESS_TOKEN_SECRET }}
          JWT_REFRESH_TOKEN_SECRET: ${{ secrets.JWT_REFRESH_TOKEN_SECRET }}
          RABBITMQ_PASSWORD: ${{ secrets.RABBITMQ_PASSWORD }}
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        run: |
          required_vars=(STACK_NAME GHCR_TOKEN POSTGRES_PASSWORD MINIO_ACCESS_KEY MINIO_SECRET_KEY JWT_ACCESS_TOKEN_SECRET JWT_REFRESH_TOKEN_SECRET RABBITMQ_PASSWORD TELEGRAM_BOT_TOKEN)
          missing=0
          for name in "${required_vars[@]}"; do
            if [ -z "${!name}" ]; then
              echo "::error::Missing required deployment setting: ${name}"
              missing=1
            fi
          done
          if [ "$missing" -ne 0 ]; then
            exit 1
          fi

      - name: Verify Docker connectivity
        run: docker info

      - name: Log in to GitHub Container Registry
        env:
          GHCR_USERNAME: ${{ secrets.GHCR_USERNAME || github.repository_owner }}
          GHCR_TOKEN: ${{ secrets.GHCR_TOKEN }}
        run: |
          if [ -z "$GHCR_TOKEN" ]; then
            echo "GHCR_TOKEN secret is required for deployment" >&2
            exit 1
          fi
          echo "$GHCR_TOKEN" | docker login ghcr.io -u "$GHCR_USERNAME" --password-stdin

      - name: Pull latest images
        run: |
          docker pull ghcr.io/radiophp/my-ads-api:latest
          docker pull ghcr.io/radiophp/my-ads-ui:latest

      - name: Deploy stack
        env:
          POSTGRES_PASSWORD: ${{ secrets.POSTGRES_PASSWORD }}
          MINIO_ACCESS_KEY: ${{ secrets.MINIO_ACCESS_KEY }}
          MINIO_SECRET_KEY: ${{ secrets.MINIO_SECRET_KEY }}
          JWT_ACCESS_TOKEN_SECRET: ${{ secrets.JWT_ACCESS_TOKEN_SECRET }}
          JWT_REFRESH_TOKEN_SECRET: ${{ secrets.JWT_REFRESH_TOKEN_SECRET }}
          RABBITMQ_PASSWORD: ${{ secrets.RABBITMQ_PASSWORD }}
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          DATABASE_DIRECT_URL: ${{ secrets.DATABASE_DIRECT_URL }}
          OTP_SENDER_API_KEY: ${{ secrets.OTP_SENDER_API_KEY }}
          NEXT_PUBLIC_ANALYTICS_WRITE_KEY: ${{ secrets.NEXT_PUBLIC_ANALYTICS_WRITE_KEY }}
          OTEL_EXPORTER_OTLP_HEADERS: ${{ secrets.OTEL_EXPORTER_OTLP_HEADERS }}
          APP_PORT: ${{ vars.APP_PORT }}
          APP_GLOBAL_PREFIX: ${{ vars.APP_GLOBAL_PREFIX }}
          POSTGRES_DB: ${{ vars.POSTGRES_DB }}
          POSTGRES_USER: ${{ vars.POSTGRES_USER }}
          POSTGRES_PORT: ${{ vars.POSTGRES_PORT }}
          REDIS_HOST: ${{ vars.REDIS_HOST }}
          REDIS_PORT: ${{ vars.REDIS_PORT }}
          REDIS_DB: ${{ vars.REDIS_DB }}
          REDIS_TLS: ${{ vars.REDIS_TLS }}
          REDIS_KEY_PREFIX: ${{ vars.REDIS_KEY_PREFIX }}
          RABBITMQ_USERNAME: ${{ vars.RABBITMQ_USERNAME }}
          RABBITMQ_QUEUE_PREFIX: ${{ vars.RABBITMQ_QUEUE_PREFIX }}
          RABBITMQ_PREFETCH: ${{ vars.RABBITMQ_PREFETCH }}
          RABBITMQ_HEARTBEAT: ${{ vars.RABBITMQ_HEARTBEAT }}
          RABBITMQ_RECONNECT_SECONDS: ${{ vars.RABBITMQ_RECONNECT_SECONDS }}
          MINIO_ENDPOINT: ${{ vars.MINIO_ENDPOINT }}
          MINIO_PORT: ${{ vars.MINIO_PORT }}
          MINIO_CONSOLE_PORT: ${{ vars.MINIO_CONSOLE_PORT }}
          MINIO_USE_SSL: ${{ vars.MINIO_USE_SSL }}
          MINIO_BUCKET: ${{ vars.MINIO_BUCKET }}
          MINIO_REGION: ${{ vars.MINIO_REGION }}
          CORS_ORIGIN: ${{ vars.CORS_ORIGIN }}
          RATE_LIMIT_TTL: ${{ vars.RATE_LIMIT_TTL }}
          RATE_LIMIT_MAX: ${{ vars.RATE_LIMIT_MAX }}
          OTP_TTL_SECONDS: ${{ vars.OTP_TTL_SECONDS }}
          OTP_DIGITS: ${{ vars.OTP_DIGITS }}
          OTP_SENDER_BASE_URL: ${{ vars.OTP_SENDER_BASE_URL }}
          RABBITMQ_URL: ${{ vars.RABBITMQ_URL }}
          OTEL_ENABLED: ${{ vars.OTEL_ENABLED }}
          OTEL_SERVICE_NAME: ${{ vars.OTEL_SERVICE_NAME }}
          OTEL_EXPORTER_OTLP_ENDPOINT: ${{ vars.OTEL_EXPORTER_OTLP_ENDPOINT }}
          OTEL_LOG_LEVEL: ${{ vars.OTEL_LOG_LEVEL }}
          LOG_LEVEL: ${{ vars.LOG_LEVEL }}
          LOG_PRETTY: ${{ vars.LOG_PRETTY }}
          PRISMA_LOG_QUERIES: ${{ vars.PRISMA_LOG_QUERIES }}
          NEXT_UI_PORT: ${{ vars.NEXT_UI_PORT }}
          NEXT_PUBLIC_APP_URL: ${{ vars.NEXT_PUBLIC_APP_URL }}
          NEXT_PUBLIC_API_BASE_URL: ${{ vars.NEXT_PUBLIC_API_BASE_URL }}
          API_REPLICAS: ${{ vars.API_REPLICAS }}
          API_CRON_REPLICAS: ${{ vars.API_CRON_REPLICAS }}
          UI_REPLICAS: ${{ vars.UI_REPLICAS }}
        run: docker stack deploy -c docker-compose-prod.yml "$STACK_NAME" --with-registry-auth
